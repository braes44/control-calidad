<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Calidad - Ingreso y Gráficos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        input { width: 60px; text-align: center; }
        input[type="text"], input[type="datetime-local"] { width: 150px; }
        button { padding: 10px; margin: 5px; }
        #resultados { margin-top: 20px; }
        .limit-input { width: 80px; }
        #analisis { width: 100%; height: 100px; margin-top: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Control de Calidad o control de procesos</h1>

    <!-- Configuración General -->
    <h2>Configuración General</h2>
    <label>Título de Datos: <input type="text" id="tituloDatos" value="Ingresar Datos de Datos_1 "></label><br>
    <label>Analista: <input type="text" id="analista" placeholder="Nombre del analista"></label><br>
    <label>Lote: <input type="text" id="lote" placeholder="Nombre del lote"></label><br>
    <label>Hora Inicio: <input type="datetime-local" id="horaInicio"></label><br>
    <label>Hora Final: <input type="datetime-local" id="horaFinal"></label><br>

    <!-- Configuración de Límites de Especificación -->
    <h2>Límites de Especificación</h2>
    <label>Límite Superior (LES): <input type="number" id="les" value="116" class="limit-input"></label>
    <label>Límite Inferior (LEI): <input type="number" id="lei" value="107" class="limit-input"></label>

    <!-- Nivel de Confianza -->
    <h2>Nivel de Confianza para Intervalos</h2>
    <label>Elegir nivel de confianza: 
        <select id="confidenceLevel">
            <option value="90">90%</option>
            <option value="95" selected>95%</option>
            <option value="99">99%</option>
        </select>
    </label>

    <!-- Primera Sección de Ingreso de Datos -->
    <h2 id="tituloDatosH2">Ingresar Datos de Datos_1</h2>
    <table id="tablaPeso1">
        <thead>
            <tr>
                <th>Muestra</th>
                <th>Lote 1</th>
                <th>Lote 2</th>
                <th>Lote 3</th>
            </tr>
        </thead>
        <tbody id="tablaBody1">
            <tr><td>1</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>2</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>3</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>4</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>5</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>6</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>7</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>8</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>9</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>10</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
        </tbody>
    </table>
    <button onclick="agregarFila(1)">Agregar Muestra (Datos_1)</button>
    <label><input type="checkbox" id="mostrarLimites1" checked> Mostrar Límites de Control en el Gráfico</label>

    <!-- Segunda Sección de Ingreso de Datos -->
    <h2>Ingresar Datos 2 </h2>
    <table id="tabla2">
        <thead>
            <tr>
                <th>Muestra</th>
                <th>Lote 1</th>
                <th>Lote 2</th>
                <th>Lote 3</th>
            </tr>
        </thead>
        <tbody id="tablaBody2">
            <tr><td>1</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>2</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>3</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>4</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>5</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>6</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>7</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>8</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>9</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
            <tr><td>10</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td></tr>
        </tbody>
    </table>
    <button onclick="agregarFila(2)">Agregar Muestra Datos_2</button>
    <label><input type="checkbox" id="mostrarLimites2" checked> Mostrar Límites de Control en el Gráfico</label>

    <br>
    <button onclick="calcularEstadisticas()">Calcular y Graficar</button>

    <!-- Resultados -->
    <div id="resultados">
        <h2>Resultados</h2>
        <p>Analista: <span id="analistaRes"></span></p>
        <p>Lote: <span id="loteRes"></span></p>
        <p>Hora Inicio: <span id="horaInicioRes"></span></p>
        <p>Hora Final: <span id="horaFinalRes"></span></p>
        <table id="tablaResultados">
            <tr><th>Estadístico</th><th>Lote 1</th><th>Lote 2</th><th>Lote 3</th></tr>
            <tr><td>Promedio Datos_1</td><td id="avg1_1"></td><td id="avg1_2"></td><td id="avg1_3"></td></tr>
            <tr><td>Desv. Est. Datos_1</td><td id="std1_1"></td><td id="std1_2"></td><td id="std1_3"></td></tr>
            <tr><td>Rango Datos_1</td><td id="range1_1"></td><td id="range1_2"></td><td id="range1_3"></td></tr>
            <tr><td>Máximo Datos_1</td><td id="max1_1"></td><td id="max1_2"></td><td id="max1_3"></td></tr>
            <tr><td>Mínimo Datos_1</td><td id="min1_1"></td><td id="min1_2"></td><td id="min1_3"></td></tr>
            <tr><td>LCS Datos_1</td><td id="lcs1_1"></td><td id="lcs1_2"></td><td id="lcs1_3"></td></tr>
            <tr><td>LCI Datos_1</td><td id="lci1_1"></td><td id="lci1_2"></td><td id="lci1_3"></td></tr>
            <tr><td>Intervalo Confianza Sup. Datos_1</td><td id="confSup1_1"></td><td id="confSup1_2"></td><td id="confSup1_3"></td></tr>
            <tr><td>Intervalo Confianza Inf. Datos_1</td><td id="confInf1_1"></td><td id="confInf1_2"></td><td id="confInf1_3"></td></tr>
            <tr><td>Cp Datos_1</td><td id="cp1_1"></td><td id="cp1_2"></td><td id="cp1_3"></td></tr>
            <tr><td>Cpk Sup Datos_1</td><td id="cpkSup1_1"></td><td id="cpkSup1_2"></td><td id="cpkSup1_3"></td></tr>
            <tr><td>Cpk Inf Datos_1</td><td id="cpkInf1_1"></td><td id="cpkInf1_2"></td><td id="cpkInf1_3"></td></tr>
            <tr><td>Promedio Datos_2</td><td id="avg2_1"></td><td id="avg2_2"></td><td id="avg2_3"></td></tr>
            <tr><td>Desv. Est. Datos_2</td><td id="std2_1"></td><td id="std2_2"></td><td id="std2_3"></td></tr>
            <tr><td>Rango Datos_2</td><td id="range2_1"></td><td id="range2_2"></td><td id="range2_3"></td></tr>
            <tr><td>Máximo Datos_2</td><td id="max2_1"></td><td id="max2_2"></td><td id="max2_3"></td></tr>
            <tr><td>Mínimo Datos_2</td><td id="min2_1"></td><td id="min2_2"></td><td id="min2_3"></td></tr>
            <tr><td>LCS Datos_2</td><td id="lcs2_1"></td><td id="lcs2_2"></td><td id="lcs2_3"></td></tr>
            <tr><td>LCI Datos_2</td><td id="lci2_1"></td><td id="lci2_2"></td><td id="lci2_3"></td></tr>
            <tr><td>Intervalo Confianza Sup. Datos_2</td><td id="confSup2_1"></td><td id="confSup2_2"></td><td id="confSup2_3"></td></tr>
            <tr><td>Intervalo Confianza Inf. Datos_2</td><td id="confInf2_1"></td><td id="confInf2_2"></td><td id="confInf2_3"></td></tr>
            <tr><td>Cp Datos_2</td><td id="cp2_1"></td><td id="cp2_2"></td><td id="cp2_3"></td></tr>
            <tr><td>Cpk Sup Datos_2</td><td id="cpkSup2_1"></td><td id="cpkSup2_2"></td><td id="cpkSup2_3"></td></tr>
            <tr><td>Cpk Inf Datos_2</td><td id="cpkInf2_1"></td><td id="cpkInf2_2"></td><td id="cpkInf2_3"></td></tr>
        </table>
        <textarea id="analisis" placeholder="Escribe tu análisis de la gráfica aquí..."></textarea>
    </div>

    <!-- Gráficas -->
    <h2>Gráfico de Datos_1</h2>
    <canvas id="graficoPeso1" width="400" height="200"></canvas>
    <h2>Gráfico de Datos_2</h2>
    <canvas id="graficoPeso2" width="400" height="200"></canvas>

    <script>
        let chart1, chart2;
        let numMuestras1 = 10, numMuestras2 = 10;

        function agregarFila(tipo) {
            if (tipo === 1) {
                numMuestras1++;
                const tbody = document.getElementById('tablaBody1');
                const nuevaFila = document.createElement('tr');
                nuevaFila.innerHTML = `<td>${numMuestras1}</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td>`;
                tbody.appendChild(nuevaFila);
            } else {
                numMuestras2++;
                const tbody = document.getElementById('tablaBody2');
                const nuevaFila = document.createElement('tr');
                nuevaFila.innerHTML = `<td>${numMuestras2}</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td>`;
                tbody.appendChild(nuevaFila);
            }
        }

        function calcularEstadisticas() {
            const tituloDatos = document.getElementById('tituloDatos').value;
            document.getElementById('tituloDatosH2').textContent = tituloDatos;

            const analista = document.getElementById('analista').value || 'No especificado';
            const lote = document.getElementById('lote').value || 'No especificado';
            const horaInicio = document.getElementById('horaInicio').value || 'No especificado';
            const horaFinal = document.getElementById('horaFinal').value || 'No especificado';
            document.getElementById('analistaRes').textContent = analista;
            document.getElementById('loteRes').textContent = lote;
            document.getElementById('horaInicioRes').textContent = horaInicio;
            document.getElementById('horaFinalRes').textContent = horaFinal;

            const les = parseFloat(document.getElementById('les').value);
            const lei = parseFloat(document.getElementById('lei').value);
            const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
            const zScore = confidenceLevel === 90 ? 1.645 : confidenceLevel === 95 ? 1.96 : 2.576;

            const tablas = [
                { id: 'tablaPeso1', bodyId: 'tablaBody1', mostrarLimitesId: 'mostrarLimites1', graficoId: 'graficoPeso1', prefix: '1_' },
                { id: 'tablaPeso2', bodyId: 'tablaBody2', mostrarLimitesId: 'mostrarLimites2', graficoId: 'graficoPeso2', prefix: '2_' }
            ];

            tablas.forEach((tabla, index) => {
                const filas = document.getElementById(tabla.id).getElementsByTagName('tr');
                let datos = [[], [], []];

                for (let i = 1; i < filas.length; i++) {
                    const inputs = filas[i].getElementsByTagName('input');
                    for (let j = 0; j < 3; j++) {
                        const valor = parseFloat(inputs[j].value) || 0;
                        if (valor !== 0) datos[j].push(valor);
                    }
                }

                const resultados = datos.map((lote, i) => {
                    if (lote.length === 0) return null;

                    const avg = lote.reduce((a, b) => a + b, 0) / lote.length;
                    const max = Math.max(...lote);
                    const min = Math.min(...lote);
                    const range = max - min;
                    const std = Math.sqrt(lote.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / (lote.length - 1));
                    const lcs = avg + 3 * std;
                    const lci = avg - 3 * std;
                    const errorStd = std / Math.sqrt(lote.length);
                    const confSup = avg + zScore * errorStd;
                    const confInf = avg - zScore * errorStd;
                    const cp = (les - lei) / (6 * std);
                    const cpkSup = (les - avg) / (3 * std);
                    const cpkInf = (avg - lei) / (3 * std);

                    return { avg, std, range, max, min, lcs, lci, confSup, confInf, cp, cpkSup, cpkInf };
                });

                for (let i = 0; i < 3; i++) {
                    const res = resultados[i];
                    if (!res) {
                        document.getElementById(`avg${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`std${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`range${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`max${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`min${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`lcs${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`lci${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`confSup${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`confInf${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`cp${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`cpkSup${tabla.prefix}${i+1}`).textContent = 'N/A';
                        document.getElementById(`cpkInf${tabla.prefix}${i+1}`).textContent = 'N/A';
                        continue;
                    }
                    document.getElementById(`avg${tabla.prefix}${i+1}`).textContent = res.avg.toFixed(2);
                    document.getElementById(`std${tabla.prefix}${i+1}`).textContent = res.std.toFixed(2);
                    document.getElementById(`range${tabla.prefix}${i+1}`).textContent = res.range.toFixed(2);
                    document.getElementById(`max${tabla.prefix}${i+1}`).textContent = res.max.toFixed(2);
                    document.getElementById(`min${tabla.prefix}${i+1}`).textContent = res.min.toFixed(2);
                    document.getElementById(`lcs${tabla.prefix}${i+1}`).textContent = res.lcs.toFixed(2);
                    document.getElementById(`lci${tabla.prefix}${i+1}`).textContent = res.lci.toFixed(2);
                    document.getElementById(`confSup${tabla.prefix}${i+1}`).textContent = res.confSup.toFixed(2);
                    document.getElementById(`confInf${tabla.prefix}${i+1}`).textContent = res.confInf.toFixed(2);
                    document.getElementById(`cp${tabla.prefix}${i+1}`).textContent = res.cp.toFixed(2);
                    document.getElementById(`cpkSup${tabla.prefix}${i+1}`).textContent = res.cpkSup.toFixed(2);
                    document.getElementById(`cpkInf${tabla.prefix}${i+1}`).textContent = res.cpkInf.toFixed(2);
                }

                // Generar gráfico
                if (window[`chart${index + 1}`]) window[`chart${index + 1}`].destroy();
                const ctx = document.getElementById(tabla.graficoId).getContext('2d');
                const mostrarLimites = document.getElementById(tabla.mostrarLimitesId).checked;

                const datasets = [
                    { label: `Lote 1 (${index === 0 ? 'Peso' : 'Uniformidad'})`, data: datos[0], borderColor: 'red', fill: false },
                    { label: `Lote 2 (${index === 0 ? 'Peso' : 'Uniformidad'})`, data: datos[1], borderColor: 'blue', fill: false },
                    { label: `Lote 3 (${index === 0 ? 'Peso' : 'Uniformidad'})`, data: datos[2], borderColor: 'green', fill: false }
                ];

                if (mostrarLimites) {
                    resultados.forEach((res, i) => {
                        if (res) {
                            datasets.push({
                                label: `LCS Lote ${i+1} (${index === 0 ? 'Peso' : 'Uniformidad'})`,
                                data: Array(datos[i].length).fill(res.lcs),
                                borderColor: datasets[i].borderColor,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            });
                            datasets.push({
                                label: `LCI Lote ${i+1} (${index === 0 ? 'Peso' : 'Uniformidad'})`,
                                data: Array(datos[i].length).fill(res.lci),
                                borderColor: datasets[i].borderColor,
                                borderDash: [5, 5],
                                fill: false,
                                pointRadius: 0
                            });
                        }
                    });
                }

                window[`chart${index + 1}`] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: Math.max(...datos.map(d => d.length)) }, (_, i) => `Muestra ${i+1}`),
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: false }
                        }
                    }
                });
            });

            // Mostrar análisis
            const analisis = document.getElementById('analisis').value || 'Sin análisis';
            document.getElementById('analisis').value = analisis; // Mantener el valor
        }
    </script>
</body>
</html>
